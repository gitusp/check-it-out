system = require 'system'
page = require('webpage').create()

# get stdin
stringifiedDna = system.stdin.readLine().toString()
dna = JSON.parse stringifiedDna

# set viewport
page.viewportSize = width: dna.width, height: dna.height
page.clipRect = top: 0, left: 0, width: dna.width, height: dna.height

# get page
page.open "http://127.0.0.1:#{dna.port}/capture", ->
	# wait for bootstrap
	bootstrap = ->
		hasBootstrap = page.evaluate ->
			return window.bootstrap?

		if hasBootstrap
			page.evaluate (stringifiedDna) ->
					window.bootstrap stringifiedDna
				, stringifiedDna
			# next
			capture()

		else
			# wait
			setTimeout bootstrap, 10

	# wait for capture
	capture = ->
		isImagesReady = page.evaluate ->
			return window.imagesReady?

		if isImagesReady
			# NOTE: 直接バイナリわたしたい
			system.stdout.write page.renderBase64('png')
			phantom.exit()

		else
			# wait
			setTimeout capture, 10

	# run
	bootstrap()
