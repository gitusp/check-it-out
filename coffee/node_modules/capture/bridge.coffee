system = require 'system'
page = require('webpage').create()

# get stdin
stringifiedDna = system.stdin.readLine().toString()
dna = JSON.parse stringifiedDna

# set viewport
page.viewportSize = width: dna.width, height: dna.height

# get page
page.open 'http://127.0.0.1:1339/capture', ->
	# wait for bootstrap
	bootstrap = ->
		hasBootstrap = page.evaluate ->
			return window.bootstrap?

		if hasBootstrap
			page.evaluate (stringifiedDna) ->
					window.bootstrap stringifiedDna
				, stringifiedDna
			capture()

		else
			setTimeout bootstrap, 10
			console.log 'no bootstrap'

	# wait for capture
	capture = ->
		isImagesReady = page.evaluate ->
			return window.imagesReady?

		if isImagesReady
			system.stdout.writeLine "capturedImage"
			page.render 'debug.png'
			console.log 'rendered'
			phantom.exit()

		else
			setTimeout capture, 10
			console.log 'wait for image ready'

	# run
	bootstrap()
