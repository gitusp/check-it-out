// Generated by CoffeeScript 1.6.2
(function() {
  var dna, page, stringifiedDna, system;

  system = require('system');

  page = require('webpage').create();

  stringifiedDna = system.stdin.readLine().toString();

  dna = JSON.parse(stringifiedDna);

  page.viewportSize = {
    width: dna.width,
    height: dna.height
  };

  page.open("http://127.0.0.1:" + dna.port + "/capture", function() {
    var bootstrap, capture;

    bootstrap = function() {
      var hasBootstrap;

      hasBootstrap = page.evaluate(function() {
        return window.bootstrap != null;
      });
      if (hasBootstrap) {
        page.evaluate(function(stringifiedDna) {
          return window.bootstrap(stringifiedDna);
        }, stringifiedDna);
        return capture();
      } else {
        return setTimeout(bootstrap, 10);
      }
    };
    capture = function() {
      var isImagesReady;

      isImagesReady = page.evaluate(function() {
        return window.imagesReady != null;
      });
      if (isImagesReady) {
        system.stdout.write(page.renderBase64('png'));
        return phantom.exit();
      } else {
        return setTimeout(capture, 10);
      }
    };
    return bootstrap();
  });

}).call(this);
