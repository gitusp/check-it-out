childProcess = require 'child_process'
path = require 'path'
phantomjs = require 'phantomjs'

module.exports = class
	constructor: (@dna) ->
		@chunks = []
		@length = 0

	run: (callback) ->
		stream = childProcess.spawn phantomjs.path, [path.join __dirname, 'bridge.js']
		stream.stdin.write JSON.stringify(@dna) + "\n"

		stream.stdout.on 'data', (chunk) =>
			@chunks.push chunk
			@length += chunk.length

		stream.on 'exit', (code) =>
			if code == 0
				# ok
				buf = new Buffer @length
				i = 0

				for c in @chunks
					c.copy buf, i, 0, c.length
					i += c.length

				callback buf

			else
				callback null
